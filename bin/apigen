#!/usr/bin/env php
<?php declare(strict_types = 1);

use ApiGenX\ApiGenFactory;
use Composer\InstalledVersions;
use Nette\Utils\Finder;
use Nette\Utils\Strings;
use Symfony\Component\Console\Command\Command;
use Symfony\Component\Console\Helper\TableSeparator;
use Symfony\Component\Console\Input\InputInterface;
use Symfony\Component\Console\Input\InputOption;
use Symfony\Component\Console\Output\ConsoleOutputInterface;
use Symfony\Component\Console\SingleCommandApplication;
use Symfony\Component\Console\Style\SymfonyStyle;


if (is_file(__DIR__ . '/../vendor/autoload.php')) {
	require __DIR__ . '/../vendor/autoload.php';

} elseif (is_file(__DIR__ . '/../../../autoload.php')) {
	require __DIR__ . '/../../../autoload.php';

} else {
	fwrite(STDERR, "ERROR: unable to find autoloader\n");
	exit(1);
}

Tracy\Debugger::$strictMode = true;
Tracy\Debugger::enable(Tracy\Debugger::DEVELOPMENT);
Latte\Bridges\Tracy\BlueScreenPanel::initialize(Tracy\Debugger::getBlueScreen());

$app = new SingleCommandApplication();
$app->setName('ApiGen');
$app->setVersion(InstalledVersions::getPrettyVersion('apigen/apigen'));

$app->addOption('source', 's', InputOption::VALUE_REQUIRED, 'source directory');
$app->addOption('include', 'i', InputOption::VALUE_REQUIRED | InputOption::VALUE_IS_ARRAY, 'includes files mask', ['*.php']);
$app->addOption('exclude', 'e', InputOption::VALUE_REQUIRED | InputOption::VALUE_IS_ARRAY, 'excluded files mask', ['temp/**', 'var/**', 'vendor/**']);
$app->addOption('output', 'o', InputOption::VALUE_REQUIRED, 'output directory');
$app->addOption('workers', 'w', InputOption::VALUE_REQUIRED, 'worker count', 8);
$app->addOption('title', 't', InputOption::VALUE_REQUIRED, 'title', 'API Documentation');
$app->addOption('base-url', null, InputOption::VALUE_REQUIRED, 'base URL', '');
$app->addOption('memory-limit', null, InputOption::VALUE_REQUIRED, 'memory limit', '512M');

$app->setCode(function (InputInterface $input, ConsoleOutputInterface $output): int {
	$options = $input->getOptions();

	$workingDir = getcwd();
	$sourceDir = $options['source'] ?? $workingDir;
	$include = $options['include'];
	$exclude = $options['exclude'];
	$outputDir = $options['output'] ?? sprintf('%s/api', $workingDir);
	$workerCount = (int) $options['workers'];
	$title = $options['title'];
	$baseUrl = $options['base-url'];
	$memoryLimit = $options['memory-limit'];

	$style = new SymfonyStyle($input, $output);
	$style->title("ApiGen: Generating $title");

	if (!is_dir($sourceDir)) {
		$style->error(sprintf("Directory '%s' does not exist", $sourceDir));
		return Command::FAILURE;
	}

	if (!is_dir(dirname($outputDir))) {
		$style->error(sprintf("Directory '%s' does not exist", dirname($outputDir)));
		return Command::FAILURE;
	}

	if (!ini_set('memory_limit', $memoryLimit)) {
		$style->warning('Failed to configure memory limit');
	}

	$sourceDir = realpath($sourceDir);
	$outputDir = realpath(dirname($outputDir)) . DIRECTORY_SEPARATOR . basename($outputDir);
	$files = Finder::findFiles(...$include)->exclude(...$exclude)->from($sourceDir);
	$files = array_keys(iterator_to_array($files));

	if (!count($files)) {
		$style->error('No source files found.');
		return Command::FAILURE;

	} elseif ($style->isDebug()) {
		$style->text('<info>Matching source files:</info>');
		$style->newLine();
		$style->listing($files);

	} elseif ($style->isVerbose()) {
		$style->text(sprintf('Found %d source files.', count($files)));
	}

	$files = array_map('realpath', $files);
	$baseDir = Strings::findPrefix($files);

	if ($style->isDebug()) {
		$style->definitionList(
			'Resolved Configuration',
			new TableSeparator(),
			['sourceDir' => $sourceDir],
			['outputDir' => $outputDir],
			['baseDir' => $baseDir],
			['baseUrl' => $baseUrl],
			['memoryLimit' => $memoryLimit],
			['workerCount' => $workerCount],
		);
	}

	$apiGenFactory = new ApiGenFactory();
	$apiGen = $apiGenFactory->create($style, $sourceDir, $baseDir, $baseUrl, $workerCount);
	$apiGen->generate($style, $files, $outputDir, $title);

	return Command::SUCCESS;
});

$app->run();
